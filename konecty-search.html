<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js" charset="utf-8"></script>

<script type="text/x-red" data-template-name="konecty-search">
  <input type="hidden" id="node-input-filter">
  <div class="form-row">
    <label for="node-input-name"><i class="icon-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name">
  </div>
  <div class="form-row">
    <label for="node-input-url"><i class="icon-tag"></i> URL</label>
    <input type="text" id="node-input-url" placeholder="Konecty Server URL">
  </div>
  <div class="form-row">
    <label for="node-input-token"><i class="icon-tag"></i> Token</label>
    <input type="text" id="node-input-token" placeholder="Your Konecty access token">
  </div>
  <div class="form-row form-row-search" style="display:none">
    <label for="node-input-doc"><i class="fa fa-dot-circle-o"></i> <span>Document</span></label>
    <select id="node-input-doc">
      <option value=""></option>
    </select>
  </div>
  <div class="form-row form-row-search node-input-rule-container-row" style="display:none">
    <ol id="node-input-rule-container" class="red-ui-editableList-list ui-sortable" style="min-height: 200px; min-width: 450px; height: auto;">
    </ol>
  </div>
</script>

<script type="text/x-red" data-help-name="konecty-search">
  <p>A full featured search node for Konecty CRM entities.</p>
  <p>For the first time, you need to fill data, click save and then reopen node to be able to add filters.</p>
</script>

<script type="text/javascript">
  var operatorsByType = {
    // any: [ 'equals', 'not_equals', 'starts_with', 'end_with', 'contains', 'not_contains', 'less_than', 'greater_than', 'less_or_equals', 'greater_or_equals', 'between', 'current_user', 'not_current_user', 'current_user_group', 'not_current_user_group', 'current_user_groups', 'in', 'not_in', 'exists'],
    any: [ 'equals', 'not_equals', 'starts_with', 'end_with', 'contains', 'not_contains', 'between', 'less_than', 'greater_than', 'less_or_equals', 'greater_or_equals', 'exists', 'lookup'],
  	text: ['exists', 'equals', 'not_equals', 'in', 'not_in', 'contains', 'not_contains', 'starts_with', 'end_with'],
  	url: ['exists', 'equals', 'not_equals', 'in', 'not_in', 'contains', 'not_contains', 'starts_with', 'end_with'],
  	'email.address': ['exists', 'equals', 'not_equals', 'in', 'not_in', 'contains', 'not_contains', 'starts_with', 'end_with'],
  	number: [ 'exists', 'equals', 'not_equals', 'in', 'not_in', 'less_than', 'greater_than', 'less_or_equals', 'greater_or_equals', 'between'],
  	autoNumber: [ 'exists', 'equals', 'not_equals', 'in', 'not_in', 'less_than', 'greater_than', 'less_or_equals', 'greater_or_equals', 'between'],
  	date: [ 'exists', 'equals', 'not_equals', 'in', 'not_in', 'less_than', 'greater_than', 'less_or_equals', 'greater_or_equals', 'between'],
  	dateTime: [ 'exists', 'equals', 'not_equals', 'in', 'not_in', 'less_than', 'greater_than', 'less_or_equals', 'greater_or_equals', 'between'],
  	'money.currency': [ 'exists', 'equals', 'not_equals', 'in', 'not_in', 'less_than', 'greater_than', 'less_or_equals', 'greater_or_equals', 'between'],
  	'money.value': [ 'exists', 'equals', 'not_equals', 'in', 'not_in', 'less_than', 'greater_than', 'less_or_equals', 'greater_or_equals', 'between'],
  	boolean: ['exists', 'equals', 'not_equals'],
  	'address.country': ['exists', 'equals', 'not_equals'],
  	'address.city': ['exists', 'equals', 'not_equals', 'in', 'not_in', 'contains', 'not_contains', 'starts_with', 'end_with'],
  	'address.state': ['exists', 'equals', 'not_equals', 'in', 'not_in'],
  	'address.district': ['exists', 'equals', 'not_equals', 'in', 'not_in'],
  	'address.place': ['exists', 'equals', 'not_equals', 'contains'],
  	'address.number': ['exists', 'equals', 'not_equals'],
  	'address.postalCode': ['exists', 'equals', 'not_equals', 'contains'],
  	'address.complement': ['exists', 'equals', 'not_equals', 'contains'],
  	'address.geolocation.0': [ 'exists', 'equals', 'not_equals', 'in', 'not_in', 'less_than', 'greater_than', 'less_or_equals', 'greater_or_equals', 'between'],
  	'address.geolocation.1': [ 'exists', 'equals', 'not_equals', 'in', 'not_in', 'less_than', 'greater_than', 'less_or_equals', 'greater_or_equals', 'between'],
  	'personName.first': ['exists', 'equals', 'not_equals', 'contains', 'not_contains', 'starts_with', 'end_with'],
  	'personName.last': ['exists', 'equals', 'not_equals', 'contains', 'not_contains', 'starts_with', 'end_with'],
  	'personName.full': ['exists', 'equals', 'not_equals', 'contains', 'not_contains', 'starts_with', 'end_with'],
  	'phone.phoneNumber': ['exists', 'equals', 'not_equals', 'in', 'not_in', 'contains', 'not_contains', 'starts_with', 'end_with'],
  	'phone.countryCode': ['exists', 'equals', 'not_equals', 'in', 'not_in'],
  	picklist: ['exists', 'equals', 'not_equals', 'in', 'not_in'],
  	lookup: ['exists'],
  	'lookup._id': ['exists', 'equals', 'not_equals', 'in', 'not_in'],
  	ObjectId: ['exists', 'equals', 'not_equals', 'in', 'not_in'],
  	encrypted: ['exists', 'equals', 'not_equals'],
  	filter: ['exists'],
  	'filter.conditions': ['exists'],
  	richText: ['exists', 'contains'],
  	file: ['exists'],
  	percentage: ['exists', 'equals', 'not_equals', 'less_than', 'greater_than', 'less_or_equals', 'greater_or_equals', 'between']
  };

  function t_operators(lang) {
    return ({
      pt_BR: {
        "equals": "igual", "not_equals": "diferente", "starts_with": "começa com", "end_with": "termina com", "contains": "contém", "not_contains": "não contém", "less_than": "menor que", "greater_than": "maior que", "less_or_equals": "menor ou igual a", "greater_or_equals": "maior ou igual a", "between": "entre", "current_user": "usuário logado", "not_current_user": "outro usuário", "current_user_group": "grupo do usuário logado", "not_current_user_group": "outro grupo do usuário",   "current_user_groups": "grupos do usuário logado", "in": "está em []", "not_in": "não está em []", "exists": "existe", "lookup": "lookup"
      },
      en: {
        "equals": "equals", "not_equals": "not equals", "starts_with": "starts with", "end_with": "end with", "contains": "contains", "not_contains": "not contains", "less_than": "less than", "greater_than": "greater than", "less_or_equals": "less or equals", "greater_or_equals": "greater or equals", "between": "between", "current_user": "current user", "not_current_user": "not current user", "current_user_group": "current user group", "not_current_user_group": "not current user group", "current_user_groups": "current user groups", "in": "in", "not_in": "not in", "exists": "exists", "lookup": "lookup"
      }
    })[lang]
  }

  // adds a filter in the list
  function addFilter(row, index, data, kondata) {
    kondata = kondata || data; // to work with editableList when calling addItem programatically
    $(row).html(`
      <table style="width:100%">
        <tr>
          <td style="width:24%;">
            <select id="konecty-search-term-`+ index +`" class="konecty-search-term" onChange="onChangeTerm(event,`+ index +`)" style="width:100%">
              <option></option>
            </select>
          </td>
          <td style="width:29%;">
            <select id="konecty-search-operator-`+ index +`" class="konecty-search-operator" onChange="onChangeOperator(event,`+ index +`)" style="width:100%;">
              <option></option>
            </select>
          </td>
          <td style="width:45%;">
            <input id="konecty-search-type-`+ index +`" class="konecty-search-type" type="hidden"></input>
            <input id="konecty-search-value-`+ index +`" class="konecty-search-value" type="text" style="width:100%;"></input>
            <input id="konecty-search-lookupId-`+ index +`" class="konecty-search-lookupId" type="hidden"></input>
            <input id="konecty-search-lookupValue-`+ index +`" class="konecty-search-lookupValue" type="text" style="width:100%; display:none;"></input>
            <div id="konecty-search-period-`+ index +`" style="display:none; width:100%;">
              <input id="konecty-search-from-`+ index +`" class="konecty-search-from" type="text" style="width:60%"></input>
              <select id="konecty-search-fromTime-`+ index +`" class="konecty-search-fromTime" style="width:37%" name=""></select>
              <br>
              <input id="konecty-search-to-`+ index +`" class="konecty-search-to" type="text" style="width:60%"></input>
              <select id="konecty-search-toTime-`+ index +`" class="konecty-search-toTime" style="width:37%" name=""></select>
            </div>
          </td>
        </tr>
      </table>
    `);
    let doc = $("#node-input-doc").val();
    let fields = kondata[doc] ? kondata[doc]['fields'] : [];
    let ff = fields.map(f => {return {value: f.name, label: f.label.pt_BR} });
    ff = sortArrayByAttribute(ff, "label");
    for (f of ff) {
      $("#konecty-search-term-" + index ).append($("<option></option>").attr("value", f.value).text(f.label));
    }
    $(".konecty-search-value").typedInput();
    $(".konecty-search-value").typedInput("types", ["msg", "flow", "global", "str", "num", "bool", "date"]);
    $("#konecty-search-from-" + index ).datepicker();
    $("#konecty-search-to-" + index ).datepicker();
    // time inputs
    let minutes_interval = 15;
    let minutes_in_day = 24 * 60;
    let startOfDay = moment().endOf('day').subtract(minutes_interval-1, 'minutes'); // 00:00
    let times = [];
    for (let i=0, j=minutes_in_day/minutes_interval; i<j; i++) {
      let time = startOfDay.add(minutes_interval, 'minutes').format('HH:mm');
      $("#konecty-search-fromTime-" + index ).append($("<option></option>").attr("value", time).text(time));
      $("#konecty-search-toTime-" + index ).append($("<option></option>").attr("value", time).text(time));
    }
  }

  // changes operators based on field type
  function onChangeTerm(event, index) {
    // TODO: 'any' is hardcoded yet
    let operators = operatorsByType['any'].map(function (o){return {label: t_operators('pt_BR')[o], value: o}});
    $("#konecty-search-operator-"+ index).html("");
    $.each(operators, function(idx, op) {
      $("#konecty-search-operator-"+ index).append($("<option></option>").attr("value", op.value).text(op.label));
    });
    onChangeOperator(event, index);
  }

  function onChangeOperator(event, index) {
    let op = event.target.value;
    let typedInput = $("#konecty-search-value-" + index).closest(".red-ui-typedInput-container");
    let lookupValue = $("#konecty-search-lookupValue-" + index);
    let period = $("#konecty-search-period-" + index);
    typedInput.hide(); lookupValue.hide(); period.hide();
    if (op == "lookup") lookupDocument(index);
    else if (op === "between") period.show();
    else if (op !== "exists") typedInput.show();
  }

  function lookupDocument(index) {
    let doc = $("#node-input-doc").val();
    let term = $("#konecty-search-term-" + index).val();
    let credentials = getCredentials();
    let searchUrl = credentials.root_url + "/rest/data/" + (doc.split(':')[1]) + "/lookup/" + term + "?page=1&start=0&limit=100&search=";
    $("#konecty-search-lookupValue-" + index).show();
    $("#konecty-search-lookupValue-" + index).autocomplete({
      source: function (request, response) {
        $.ajax({
          headers: {
            'Authorization': credentials.token,
          },
          url: searchUrl+ request.term,
          dataType: "json",
          success: kondata => {
            response(kondata.data.map(k => {
              return {id: k._id, value: k.name}
            }));
          }
        });
      },
      minLength: 2,
      select: function ( event, ui ) {
        $("#konecty-search-lookupId-" + index).val(ui.item.id);
      }
    });
  }

  // sorts an array of objects by one of its attributes
  function sortArrayByAttribute(arr, attr) {
    return arr.sort((a,b) => (a[attr] > b[attr]) ? 1 : ((b[attr] > a[attr]) ? -1 : 0));
  }

  // load Documents and fill select options
  function loadDocuments(kondata, doc) {
    let documents = [];
    Object.keys(kondata).forEach(function (key) {
      if (kondata[key].type === 'document') {
        documents.push({value: key, label: kondata[key].label.pt_BR});
      }
    });
    documents = sortArrayByAttribute(documents, "label");
    for (d of documents) {
      $('#node-input-doc').append($("<option></option>").attr("value", d.value).text( d.label ));
    }
    $('#node-input-doc').on('change', function () {
      $("#node-input-rule-container").editableList('empty');
    });
    if (doc) {
      $('#node-input-doc').val(doc);
    }
  }

  // loads all existing filters when editing
  function loadFilters(kondata, filter) {
    let f = JSON.parse(filter);
    $.each(f.conditions, function (idx, condition) {
      $("#node-input-rule-container").editableList('addItem', kondata);
      setTimeout(function () {
        $("#konecty-search-term-" + idx).val(condition.term).change();
        let typedInput = $("#konecty-search-value-" + idx).closest(".red-ui-typedInput-container");
        let lookup = $("#konecty-search-lookupValue-" + idx);
        let period = $("#konecty-search-period-" + idx);
        lookup.val(condition.lookupValue);
        $("#konecty-search-value-" + idx).typedInput("value", condition.value).typedInput("type", condition.type);
        $("#konecty-search-operator-" + idx).val(condition.operator);
        $("#konecty-search-lookupId-" + idx).val(condition.lookupId);
        $("#konecty-search-type-" + idx).val(condition.type);
        $("#konecty-search-from-" + idx).val(condition.from);
        $("#konecty-search-to-" + idx).val(condition.to);
        $("#konecty-search-fromTime-" + idx).val(condition.fromTime);
        $("#konecty-search-toTime-" + idx).val(condition.toTime);
        // visibility
        typedInput.hide(); lookup.hide(); period.hide();
        if (condition.operator === "lookup") lookupDocument(idx);
        else if (condition.operator === "between") period.show();
        else if (condition.operator !== "exists") typedInput.show();
      }, 10);
    });
  }

  // init widgets
  function initKonectySearch(kondata, doc, filter) {
    loadDocuments(kondata, doc);
    $('.form-row-search').show();
    $("#node-input-rule-container").editableList({
      sortable: true,
      removable: true,
      addItem: function(row, index, data) {
        addFilter(row, index, data, kondata);
      }
    });
    loadFilters(kondata, filter);
  }

  // stores konecty filter to search api
  function saveKonectyFilter() {
    let search_terms = $(".konecty-search-term");
    let search_operators = $(".konecty-search-operator");
    let search_types = $(".konecty-search-type");
    let search_values = $(".konecty-search-value");
    let conditions = [];
    for (let i=0, j=search_terms.length; i < j; i++) {
      let type = $("#konecty-search-value-"+i).typedInput('type');
      let value = $("#konecty-search-value-"+i).typedInput('value');
      let lookupId = $("#konecty-search-lookupId-"+i).val();
      let lookupValue = $("#konecty-search-lookupValue-"+i).val();
      let from = $("#konecty-search-from-"+i).val();
      let to = $("#konecty-search-to-"+i).val();
      let fromTime = $("#konecty-search-fromTime-"+i).val();
      let toTime = $("#konecty-search-toTime-"+i).val();
      conditions.push({
        term: search_terms[i].value,
        operator: search_operators[i].value,
        type: type,
        value: value,
        lookupId: lookupId,
        lookupValue: lookupValue,
        from: from,
        to: to,
        fromTime: fromTime,
        toTime: toTime
      });
    }
    $("#node-input-filter").val(JSON.stringify({match: 'and', conditions: conditions}));
  }
</script>

<script type="text/javascript">
  var getCredentials = function () {
    return null;
  };
  RED.nodes.registerType('konecty-search',{
    category: 'Konecty CRM',
    color: '#60C8DE',
    defaults: {
      name: {value:""},
      doc: {value:""},
      filter: {value:""}
    },
    credentials: {
      url: {value:"",required:true},
      token: {value:"",required:true},
      namespace: {value:""}
    },
    oneditprepare: function () {
      let root_url = this.credentials.url.trim();
      let token = this.credentials.token.trim();
      if (root_url && token) {
        if (root_url.endsWith('/')) {
          root_url = root_url.slice(0, root_url.length-1);
        }
        getCredentials = function () {
          return {root_url: root_url, token: token}
        };
        $.ajax({
          headers: {
            'Authorization': token,
          },
          url: root_url + "/rest/menu/list",
          dataType: "json",
          success: kondata => {
            initKonectySearch(kondata, this.doc, this.filter);
          }
        });
      }
    },
    oneditsave: function () {
      saveKonectyFilter();
    },
    inputs:1,
    outputs:1,
    icon: "file.png",
    label: function () {
      return this.name || "konecty-search";
    }
  });
</script>
